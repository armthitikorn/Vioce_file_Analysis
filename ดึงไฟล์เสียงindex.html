<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายการไฟล์เสียง</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Tahoma', sans-serif;
            background: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #333;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            color: #004085;
            margin-bottom: 20px;
        }
        #audioList {
            list-style: none;
            padding: 0;
            margin: 20px 0;
            text-align: left;
        }
        .audio-item {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border: 1px solid #e2e6ea;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .audio-item p {
            margin: 0;
            flex-grow: 1;
            font-size: 1.1em;
            color: #555;
        }
        audio {
            width: 250px;
            margin-left: 15px;
        }
        .message {
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>รายการไฟล์เสียงของฉัน</h1>
        <p>คุณกำลังล็อกอินด้วย: <strong id="userEmail">กำลังโหลด...</strong></p>
        <ul id="audioList">
            </ul>
        <p id="loadingMessage" class="message">กำลังโหลดไฟล์เสียง...</p>
        <p id="noFilesMessage" class="message" style="display:none;">ไม่พบไฟล์เสียงของคุณ</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // **แก้ไขตรงนี้** ให้เป็นค่า Firebase Config ของคุณ
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // รอการยืนยันตัวตนของผู้ใช้งาน
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ผู้ใช้ล็อกอินแล้ว
                document.getElementById('userEmail').textContent = user.email || "ผู้ใช้งานนิรนาม";
                fetchAudioFiles(user.uid);
            } else {
                // ถ้ายังไม่ล็อกอิน ให้ล็อกอินแบบนิรนาม
                // หรือเปลี่ยนไปใช้ signInWithRedirect/PopUp ตามที่คุณต้องการ
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Error signing in anonymously:", error);
                    alert("เกิดข้อผิดพลาดในการเข้าสู่ระบบ กรุณาลองใหม่อีกครั้ง");
                }
            }
        });

        // ฟังก์ชันสำหรับดึงไฟล์เสียงจาก Realtime Database
        async function fetchAudioFiles(userId) {
            const loadingMessage = document.getElementById('loadingMessage');
            const noFilesMessage = document.getElementById('noFilesMessage');
            const audioList = document.getElementById('audioList');
            audioList.innerHTML = ''; // Clear previous list

            loadingMessage.style.display = 'block';
            noFilesMessage.style.display = 'none';

            try {
                // สร้าง path ไปยังข้อมูลเสียงของผู้ใช้
                const dbRef = ref(db);
                const userAudioRef = child(dbRef, `submissions/${userId}`);
                const snapshot = await get(userAudioRef);

                if (snapshot.exists()) {
                    const submissions = snapshot.val();
                    let hasFiles = false;

                    for (const key in submissions) {
                        const data = submissions[key];
                        if (data.audioUrl && data.question) {
                            hasFiles = true;
                            createAudioElement(data.question, data.audioUrl);
                        }
                    }

                    if (!hasFiles) {
                        noFilesMessage.style.display = 'block';
                    }
                } else {
                    noFilesMessage.style.display = 'block';
                }
            } catch (error) {
                console.error("Error fetching audio files:", error);
                alert("เกิดข้อผิดพลาดในการดึงข้อมูล กรุณาลองใหม่อีกครั้ง");
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        // ฟังก์ชันสำหรับสร้าง element HTML ของแต่ละไฟล์เสียง
        function createAudioElement(questionText, audioUrl) {
            const li = document.createElement('li');
            li.className = 'audio-item';
            
            const p = document.createElement('p');
            p.textContent = `คำถาม: ${questionText}`;
            
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = audioUrl;

            li.appendChild(p);
            li.appendChild(audio);
            
            document.getElementById('audioList').appendChild(li);
        }

    </script>
</body>
</html>