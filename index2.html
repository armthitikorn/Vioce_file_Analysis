<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ค้นหาและฟังไฟล์เสียงจากอีเมลและวันที่</title>
  <style>
    body { font-family: 'Tahoma', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
    .container { max-width: 800px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #004085; }
    .auth-container, .search-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .auth-container input, .search-container input, .search-container button, .auth-container button { padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
    .auth-container button, .search-container button { background-color: #007bff; color: white; border: none; cursor: pointer; }
    .auth-container button:hover, .search-container button:hover { background-color: #0056b3; }
    .audio-item { border-bottom: 1px solid #e0e0e0; padding: 15px 0; }
    .audio-item:last-child { border-bottom: none; }
    .question-text { font-weight: bold; color: #0056b3; margin-bottom: 10px; }
    audio { width: 100%; margin-top: 10px; }
    .error-message { text-align: center; color: red; }
    .hidden { display: none; }
    .success-message { text-align: center; color: green; margin-bottom: 15px; }
    #logoutButton { background-color: #dc3545; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 10px; }
    #logoutButton:hover { background-color: #c82333; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ค้นหาและฟังไฟล์เสียงจากอีเมลและวันที่</h1>

    <!-- Login -->
    <div id="authContainer" class="auth-container">
      <p style="text-align: center;">กรุณาล็อกอินเพื่อเข้าถึง</p>
      <input type="email" id="loginEmailInput" placeholder="อีเมล">
      <input type="password" id="loginPasswordInput" placeholder="รหัสผ่าน">
      <button id="loginButton">เข้าสู่ระบบ</button>
      <p id="authError" class="error-message"></p>
    </div>

    <!-- Search -->
    <div id="searchSection" class="search-container hidden">
      <p id="userStatus" class="success-message"></p>
      <input type="email" id="userEmailInput" placeholder="กรอกอีเมลพนักงาน">
      <input type="date" id="dateInput">
      <button id="searchButton">ค้นหาไฟล์เสียง</button>
      <button id="logoutButton">ออกจากระบบ</button>
    </div>

    <!-- Results -->
    <div id="audioList">
      <p style="text-align: center;">กรุณาล็อกอินและค้นหา</p>
    </div>
  </div>

  <script type="module">
    // ---------------- Firebase SDK ----------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // ---------------- Config ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyA4OrZERUoxWPiShCEWVvz1MK9cYGO3_K8",
      authDomain: "new-record-3ccd6.firebaseapp.com",
      databaseURL: "https://new-record-3ccd6-default-rtdb.firebaseio.com",
      projectId: "new-record-3ccd6",
      storageBucket: "new-record-3ccd6.appspot.com",  // ✅ แก้ไข storageBucket
      messagingSenderId: "1065863160189",
      appId: "1:1065863160189:web:25313e55b0733f5e126c14",
      measurementId: "G-JW6N2HYR58"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---------------- DOM ----------------
    const authContainer = document.getElementById('authContainer');
    const loginEmailInput = document.getElementById('loginEmailInput');
    const loginPasswordInput = document.getElementById('loginPasswordInput');
    const loginButton = document.getElementById('loginButton');
    const authError = document.getElementById('authError');
    const searchSection = document.getElementById('searchSection');
    const userStatus = document.getElementById('userStatus');
    const userEmailInput = document.getElementById('userEmailInput');
    const dateInput = document.getElementById('dateInput');
    const searchButton = document.getElementById('searchButton');
    const logoutButton = document.getElementById('logoutButton');
    const audioListContainer = document.getElementById('audioList');

    // ---------------- Login ----------------
    loginButton.addEventListener('click', async () => {
      const email = loginEmailInput.value;
      const password = loginPasswordInput.value;
      authError.textContent = '';
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        authError.textContent = "ล็อกอินไม่สำเร็จ: " + error.message;
        console.error("Login error:", error);
      }
    });

    logoutButton.addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authContainer.classList.add('hidden');
        searchSection.classList.remove('hidden');
        userStatus.textContent = `เข้าสู่ระบบในฐานะ: ${user.email}`;
        audioListContainer.innerHTML = '<p style="text-align: center;">กรุณากรอกข้อมูลและกดค้นหา</p>';
      } else {
        authContainer.classList.remove('hidden');
        searchSection.classList.add('hidden');
        audioListContainer.innerHTML = '<p style="text-align: center;">กรุณาล็อกอินเพื่อเข้าถึง</p>';
      }
    });

    // ---------------- Search ----------------
    const searchUserAudios = async () => {
      const emailToSearch = userEmailInput.value.trim();
      const selectedDate = dateInput.value;
      
      if (!emailToSearch || !selectedDate) {
        audioListContainer.innerHTML = '<p class="error-message">กรุณากรอกข้อมูลให้ครบถ้วน</p>';
        return;
      }

      audioListContainer.innerHTML = '<p style="text-align: center;">กำลังค้นหา...</p>';

      try {
        const startOfDay = new Date(selectedDate);
        startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(selectedDate);
        endOfDay.setHours(23, 59, 59, 999);

        const submissionsQuery = query(
          collection(db, "submissions_part1"),
          where("email", "==", emailToSearch),
          where("timestamp", ">=", Timestamp.fromDate(startOfDay)),
          where("timestamp", "<=", Timestamp.fromDate(endOfDay))
        );

        const querySnapshot = await getDocs(submissionsQuery);

        if (querySnapshot.empty) {
          audioListContainer.innerHTML = '<p style="text-align: center;">ไม่พบไฟล์เสียงสำหรับอีเมลนี้ในวันที่เลือก</p>';
          return;
        }
        
        audioListContainer.innerHTML = '';

        for (const doc of querySnapshot.docs) {
          const data = doc.data();
          let audioURL = "";

          if (data.audioUrl && data.audioUrl.startsWith("http")) {
            // ถ้าเป็น URL อยู่แล้ว ใช้ได้เลย
            audioURL = data.audioUrl;
          } else if (data.audioPath) {
            // ถ้าเก็บ path เอาไว้ ต้องไปขอ getDownloadURL จาก Storage
            try {
              const audioRef = ref(storage, data.audioPath);
              audioURL = await getDownloadURL(audioRef);
            } catch (err) {
              console.error("GetDownloadURL error:", err);
            }
          }

          if (audioURL) {
            const audioItem = document.createElement('div');
            audioItem.className = 'audio-item';
            audioItem.innerHTML = `
              <p class="question-text"><b>ข้อที่ ${data.question || 'N/A'}:</b> ${data.text || 'ไม่มีคำอธิบาย'}</p>
              <audio controls src="${audioURL}"></audio>
            `;
            audioListContainer.appendChild(audioItem);
          } else {
            const errorMessage = document.createElement('p');
            errorMessage.className = 'error-message';
            errorMessage.textContent = `ไม่พบ URL ไฟล์เสียงสำหรับคำถามข้อที่ ${data.question || 'N/A'}`;
            audioListContainer.appendChild(errorMessage);
          }
        }

      } catch (error) {
        console.error("เกิดข้อผิดพลาดในการค้นหา: ", error);
        audioListContainer.innerHTML = '<p class="error-message">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
      }
    };

    searchButton.addEventListener('click', searchUserAudios);
  </script>
</body>
</html>






