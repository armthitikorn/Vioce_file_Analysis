<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Dashboard ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // üîπ Config Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const collectionNames = [
      "‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô_‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1",
      "‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô_‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2",
      "‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô_‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3"
    ];

    // ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    async function loadEmails() {
      let emails = new Set();
      for (let col of collectionNames) {
        const submissionsRef = collection(db, col);
        const snapshot = await getDocs(submissionsRef);
        snapshot.forEach(doc => {
          if (doc.data()["‡∏≠‡∏µ‡πÄ‡∏°‡∏•"]) {
            emails.add(doc.data()["‡∏≠‡∏µ‡πÄ‡∏°‡∏•"]);
          }
        });
      }

      const emailSelect = document.getElementById("emailSelect");
      emails.forEach(email => {
        const opt = document.createElement("option");
        opt.value = email;
        opt.textContent = email;
        emailSelect.appendChild(opt);
      });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    async function loadDates() {
      const email = document.getElementById("emailSelect").value;
      let dates = new Set();

      for (let col of collectionNames) {
        const submissionsRef = collection(db, col);
        const q = query(submissionsRef, where("‡∏≠‡∏µ‡πÄ‡∏°‡∏•", "==", email));
        const snapshot = await getDocs(q);

        snapshot.forEach(doc => {
          const ts = doc.data()["‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤"];
          if (ts) {
            const date = new Date(ts.seconds * 1000).toLocaleDateString("th-TH");
            dates.add(date);
          }
        });
      }

      const dateSelect = document.getElementById("dateSelect");
      dateSelect.innerHTML = "";
      dates.forEach(date => {
        const opt = document.createElement("option");
        opt.value = date;
        opt.textContent = date;
        dateSelect.appendChild(opt);
      });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏∏‡∏Å‡∏ï‡∏≠‡∏ô
    async function loadAudio() {
      const email = document.getElementById("emailSelect").value;
      const date = document.getElementById("dateSelect").value;
      const container = document.getElementById("audioContainer");
      container.innerHTML = "";

      for (let col of collectionNames) {
        const submissionsRef = collection(db, col);
        const q = query(submissionsRef, where("‡∏≠‡∏µ‡πÄ‡∏°‡∏•", "==", email));
        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
          const section = document.createElement("div");
          section.innerHTML = `<h3>üìÇ ${col}</h3>`;
          container.appendChild(section);

          snapshot.forEach(async (doc) => {
            const data = doc.data();
            const ts = data["‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤"];
            const docDate = new Date(ts.seconds * 1000).toLocaleDateString("th-TH");
            if (docDate !== date) return;

            const folderId = data["‡∏¢‡∏π‡πÑ‡∏≠‡∏î‡∏µ"];
            const fileName = data["URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á"];
            const filePath = `‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á/${folderId}/${fileName}`;
            const audioRef = ref(storage, filePath);

            try {
              const audioURL = await getDownloadURL(audioRef);

              const card = document.createElement("div");
              card.innerHTML = `
                <p><b>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${data["‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"]}</b>: ${data["‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"]}</p>
                <audio controls src="${audioURL}"></audio><br>
                <a href="${audioURL}" download="${fileName}">‚¨á ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>
              `;
              section.appendChild(card);
            } catch (err) {
              console.error("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
            }
          });
        }
      }
    }

    window.onload = loadEmails;
    window.loadDates = loadDates;
    window.loadAudio = loadAudio;
  </script>
</head>
<body>
  <h2>üìä Dashboard ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</h2>

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
  <select id="emailSelect" onchange="loadDates()">
    <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏• --</option>
  </select>

  <br><br>

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô:</label>
  <select id="dateSelect" onchange="loadAudio()">
    <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>
  </select>

  <br><br>

  <div id="audioContainer"></div>
</body>
</html>
