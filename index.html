<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</title>
    <style>
        body { font-family: 'Tahoma', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #004085; }
        h3 { color: #0056b3; }
        .login-container, .dashboard-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .login-container input, .login-container button { padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
        .login-container button { background-color: #007bff; color: white; border: none; cursor: pointer; }
        .login-container button:hover { background-color: #0056b3; }
        .dashboard-container { display: none; }
        .audio-item { border-bottom: 1px solid #e0e0e0; padding: 15px 0; }
        .audio-item:last-child { border-bottom: none; }
        .error-message { text-align: center; color: red; }
        .logout-button { background-color: #dc3545; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Dashboard ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</h1>
        
        <div id="loginSection" class="login-container">
            <h2 style="margin-top: 0;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <input type="email" id="loginEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
            <input type="password" id="loginPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="loginButton">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p id="loginError" class="error-message"></p>
        </div>

        <div id="dashboardSection" class="dashboard-container">
            <p id="userStatus" style="text-align: center; color: green;"></p>
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
            <select id="emailSelect"></select>

            <br>

            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô:</label>
            <select id="dateSelect"></select>
            <button onclick="loadAudio()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            
            <button id="logoutButton" class="logout-button">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>

            <div id="audioContainer" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

        // üîπ Config Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á
        const firebaseConfig = {
            apiKey: "AIzaSyA4OrZERUoxWPiShCEWVvz1MK9cYGO3_K8",
            authDomain: "new-record-3ccd6.firebaseapp.com",
            projectId: "new-record-3ccd6",
            storageBucket: "new-record-3ccd6.appspot.com",
            messagingSenderId: "1065863160189",
            appId: "1:1065863160189:web:25313e55b0733f5e126c14"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const collectionNames = [
            "‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô_‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1",
            "‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô_‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2",
            "‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô_‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3"
        ];

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');
        const emailSelect = document.getElementById("emailSelect");
        const dateSelect = document.getElementById("dateSelect");
        const audioContainer = document.getElementById("audioContainer");
        const userStatus = document.getElementById("userStatus");

        // ------------------ Authentication ------------------
        loginButton.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message;
            }
        });

        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginSection.style.display = 'none';
                dashboardSection.style.display = 'flex';
                dashboardSection.style.flexDirection = 'column'; // Add this line to fix flex direction
                userStatus.textContent = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞: ${user.email}`;
                loadEmails();
            } else {
                loginSection.style.display = 'flex';
                dashboardSection.style.display = 'none';
                audioContainer.innerHTML = '';
            }
        });

        // ------------------ Data Loading Functions ------------------
        async function loadEmails() {
            emailSelect.innerHTML = '<option value="" disabled selected>-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏µ‡πÄ‡∏°‡∏• --</option>';
            emailSelect.disabled = true;
            let emails = new Set();
            try {
                // Fetch emails from all collections
                for (let col of collectionNames) {
                    const submissionsRef = collection(db, col);
                    const snapshot = await getDocs(submissionsRef);
                    snapshot.forEach(doc => {
                        const email = doc.data()["‡∏≠‡∏µ‡πÄ‡∏°‡∏•"];
                        if (email) emails.add(email);
                    });
                }
                
                if (emails.size === 0) {
                    emailSelect.innerHTML = '<option value="" disabled selected>-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• --</option>';
                    audioContainer.innerHTML = '<p class="error-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡πÄ‡∏°‡∏•</p>';
                    return;
                }

                emailSelect.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏• --</option>';
                emails.forEach(email => {
                    const opt = document.createElement("option");
                    opt.value = email;
                    opt.textContent = email;
                    emailSelect.appendChild(opt);
                });
                emailSelect.disabled = false;
            } catch (err) {
                emailSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</option>';
                audioContainer.innerHTML = '<p class="error-message">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏µ‡πÄ‡∏°‡∏•</p>';
                console.error("Load emails error:", err);
            }
        }

        emailSelect.addEventListener('change', () => {
            dateSelect.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>';
            audioContainer.innerHTML = '';
            loadDates(emailSelect.value);
        });

        async function loadDates(email) {
            dateSelect.innerHTML = '<option value="" disabled selected>-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>';
            dateSelect.disabled = true;
            let dates = new Set();
            try {
                for (let col of collectionNames) {
                    const q = query(collection(db, col), where("‡∏≠‡∏µ‡πÄ‡∏°‡∏•", "==", email));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => {
                        const ts = doc.data()["‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤"];
                        if (ts instanceof Timestamp) {
                            const date = new Date(ts.seconds * 1000).toLocaleDateString("th-TH");
                            dates.add(date);
                        }
                    });
                }

                dateSelect.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>';
                if (dates.size > 0) {
                    dates.forEach(date => {
                        const opt = document.createElement("option");
                        opt.value = date;
                        opt.textContent = date;
                        dateSelect.appendChild(opt);
                    });
                } else {
                    dateSelect.innerHTML = '<option value="" disabled selected>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</option>';
                }
                dateSelect.disabled = false;
            } catch (err) {
                dateSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</option>';
                console.error("Load dates error:", err);
            }
        }

        window.loadAudio = async function() {
            const email = emailSelect.value;
            const dateStr = dateSelect.value;
            if (!email || !dateStr) {
                audioContainer.innerHTML = '<p class="error-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>';
                return;
            }
            audioContainer.innerHTML = '<p style="text-align: center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á...</p>';

            const [day, month, year] = dateStr.split('/');
            const selectedDate = new Date(`${year}-${month}-${day}`);
            const startOfDay = Timestamp.fromDate(new Date(selectedDate.setHours(0, 0, 0, 0)));
            const endOfDay = Timestamp.fromDate(new Date(selectedDate.setHours(23, 59, 59, 999)));

            try {
                let foundAudios = false;
                audioContainer.innerHTML = '';
                
                for (let col of collectionNames) {
                    const q = query(
                        collection(db, col),
                        where("‡∏≠‡∏µ‡πÄ‡∏°‡∏•", "==", email),
                        where("‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤", ">=", startOfDay),
                        where("‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤", "<=", endOfDay)
                    );
                    const snapshot = await getDocs(q);
                    
                    if (!snapshot.empty) {
                        foundAudios = true;
                        const section = document.createElement("div");
                        section.innerHTML = `<h3>üìÇ ${col}</h3>`;
                        audioContainer.appendChild(section);

                        const audioItems = [];
                        snapshot.forEach(doc => {
                            audioItems.push(doc.data());
                        });
                        
                        // Sort audio items by question number
                        audioItems.sort((a, b) => (a["‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"] || 0) - (b["‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"] || 0));

                        for (const data of audioItems) {
                            const folderId = data["‡∏¢‡∏π‡πÑ‡∏≠‡∏î‡∏µ"];
                            const fileName = data["URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á"];
                            const filePath = `‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á/${folderId}/${fileName}`;
                            const audioRef = ref(storage, filePath);
                            
                            try {
                                const audioURL = await getDownloadURL(audioRef);
                                const card = document.createElement("div");
                                card.className = 'audio-item';
                                card.innerHTML = `
                                    <p><b>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${data["‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"] || 'N/A'}</b>: ${data["‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°'}</p>
                                    <audio controls src="${audioURL}"></audio><br>
                                    <a href="${audioURL}" download="${fileName}">‚¨á ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>
                                `;
                                section.appendChild(card);
                            } catch (err) {
                                console.error(`‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á ${fileName} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:`, err);
                                const errorCard = document.createElement("p");
                                errorCard.className = 'error-message';
                                errorCard.textContent = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${data["‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"] || 'N/A'}`;
                                section.appendChild(errorCard);
                            }
                        }
                    }
                }

                if (!foundAudios) {
                    audioContainer.innerHTML = '<p style="text-align: center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                }

            } catch (err) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", err);
                audioContainer.innerHTML = '<p class="error-message">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }
        }
    </script>
</body>
</html>


