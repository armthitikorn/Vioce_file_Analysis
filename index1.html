<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --background-color: #f0f2f5;
            --card-background: #fff;
            --text-color: #333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 40px 20px;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--card-background);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        h1 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .login-container, .dashboard-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: 600;
            color: var(--text-color);
        }

        input, select, button {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
            font-family: 'Sarabun', sans-serif;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            cursor: pointer;
            border: none;
            color: white;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.1s;
        }

        #loginButton {
            background-color: var(--primary-color);
        }
        
        #loginButton:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        #searchButton {
            background-color: var(--primary-color);
            margin-top: 15px;
        }
        
        #searchButton:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .dashboard-container { 
            display: none; 
            align-items: center;
        }

        .user-status {
            text-align: center;
            color: var(--success-color);
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .audio-container {
            margin-top: 20px;
            width: 100%;
        }

        .audio-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .audio-item:last-child {
            margin-bottom: 0;
        }

        audio {
            width: 100%;
        }

        .audio-link {
            display: inline-block;
            background-color: var(--secondary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            text-decoration: none;
            transition: background-color 0.3s;
            text-align: center;
        }

        .audio-link:hover {
            background-color: #5a6268;
        }
        
        .error-message {
            color: var(--danger-color);
            text-align: center;
            font-weight: 600;
        }

        .logout-button {
            background-color: var(--danger-color);
            margin-top: 20px;
        }

        .logout-button:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Dashboard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h1>
        
        <div id="loginSection" class="login-container">
            <h2 style="margin-top: 0;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="input-group">
                <label for="loginEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <input type="email" id="loginEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
            </div>
            <div class="input-group">
                <label for="loginPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                <input type="password" id="loginPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            </div>
            <button id="loginButton">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p id="loginError" class="error-message"></p>
        </div>

        <div id="dashboardSection" class="dashboard-container">
            <p id="userStatus" class="user-status"></p>
            <div class="input-group">
                <label for="employeeEmailInput">‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                <input type="email" id="employeeEmailInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
            </div>
            
            <div class="input-group">
                <label for="dateSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô:</label>
                <select id="dateSelect"></select>
            </div>

            <div class="input-group">
                <label for="partSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô:</label>
                <select id="partSelect">
                    <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô --</option>
                    <option value="submissions_part1">Part 1</option>
                    <option value="submissions_part2">Part 2</option>
                    <option value="submissions_part3">Part 3</option>
                </select>
            </div>
            <button id="searchButton">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            
            <button id="logoutButton" class="logout-button">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>

            <div id="audioContainer" class="audio-container"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

        // üîπ Config Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á
        const firebaseConfig = {
        apiKey: "AIzaSyA4OrZERUoxWPiShCEWVvz1MK9cYGO3_K8",
¬†       authDomain: "new-record-3ccd6.firebaseapp.com",
¬†       databaseURL: "https://new-record-3ccd6-default-rtdb.firebaseio.com",
¬†       projectId: "new-record-3ccd6",
¬†       storageBucket: "new-record-3ccd6.firebasestorage.app",
¬†       messagingSenderId: "1065863160189",
¬†       appId: "1:1065863160189:web:853d594b8d17adff126c14",
¬†       measurementId: "G-ZY9B2K18X3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');
        const employeeEmailInput = document.getElementById("employeeEmailInput");
        const dateSelect = document.getElementById("dateSelect");
        const partSelect = document.getElementById("partSelect");
        const audioContainer = document.getElementById("audioContainer");
        const userStatus = document.getElementById("userStatus");
        const searchButton = document.getElementById("searchButton");

        // ------------------ Authentication ------------------
        loginButton.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message;
            }
        });

        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginSection.style.display = 'none';
                dashboardSection.style.display = 'flex';
                dashboardSection.style.flexDirection = 'column';
                userStatus.textContent = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞: ${user.email}`;
            } else {
                loginSection.style.display = 'flex';
                dashboardSection.style.display = 'none';
                audioContainer.innerHTML = '';
            }
        });
        
        // ------------------ Data Loading Functions ------------------
        employeeEmailInput.addEventListener('input', () => {
            const email = employeeEmailInput.value;
            if (email) {
                loadDates(email);
            } else {
                dateSelect.innerHTML = '<option value="" disabled selected>‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</option>';
                dateSelect.disabled = true;
                audioContainer.innerHTML = '';
            }
        });

        searchButton.addEventListener('click', async () => {
            const email = employeeEmailInput.value;
            const dateStr = dateSelect.value;
            const part = partSelect.value;
            
            if (!email || !dateStr || !part) {
                audioContainer.innerHTML = '<p class="error-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>';
                return;
            }

            audioContainer.innerHTML = '<p style="text-align: center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á...</p>';

            const [day, month, year] = dateStr.split('/');
            const selectedDate = new Date(`${year}-${month}-${day}`);
            const startOfDay = Timestamp.fromDate(new Date(selectedDate.setHours(0, 0, 0, 0)));
            const endOfDay = Timestamp.fromDate(new Date(selectedDate.setHours(23, 59, 59, 999)));

            try {
                let foundAudios = false;
                audioContainer.innerHTML = '';
                
                const q = query(
                    collection(db, part),
                    where("email", "==", email),
                    where("timestamp", ">=", startOfDay),
                    where("timestamp", "<=", endOfDay)
                );
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    foundAudios = true;
                    const section = document.createElement("div");
                    section.innerHTML = `<h3>üìÇ ${part}</h3>`;
                    audioContainer.appendChild(section);

                    const audioItems = [];
                    snapshot.forEach(doc => {
                        audioItems.push(doc.data());
                    });
                    
                    audioItems.sort((a, b) => (a.question || 0) - (b.question || 0));

                    for (const data of audioItems) {
                        const question = data.text || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';
                        const audioURL = data.audioUrl;
                        
                        if (audioURL) {
                            const card = document.createElement("div");
                            card.className = 'audio-item';
                            card.innerHTML = `
                                <p><b>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${data.question || 'N/A'}</b>: ${question}</p>
                                <audio controls src="${audioURL}"></audio><br>
                                <a href="${audioURL}" download="${data.uid}_${part}_answer${data.question}.mp4" class="audio-link">‚¨á ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>
                            `;
                            section.appendChild(card);
                        } else {
                            const errorCard = document.createElement("p");
                            errorCard.className = 'error-message';
                            errorCard.textContent = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${data.question || 'N/A'}`;
                            section.appendChild(errorCard);
                        }
                    }
                }

                if (!foundAudios) {
                    audioContainer.innerHTML = '<p style="text-align: center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                }

            } catch (err) {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", err);
                audioContainer.innerHTML = '<p class="error-message">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }
        });

        async function loadDates(email) {
            dateSelect.innerHTML = '<option value="" disabled selected>-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>';
            dateSelect.disabled = true;
            let dates = new Set();
            try {
                 const collections = ["submissions_part1", "submissions_part2", "submissions_part3"];
                for (const col of collections) {
                    const q = query(collection(db, col), where("email", "==", email));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => {
                        const ts = doc.data().timestamp;
                        if (ts instanceof Timestamp) {
                            const date = new Date(ts.seconds * 1000).toLocaleDateString("th-TH");
                            dates.add(date);
                        }
                    });
                }

                dateSelect.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>';
                if (dates.size > 0) {
                    dates.forEach(date => {
                        const opt = document.createElement("option");
                        opt.value = date;
                        opt.textContent = date;
                        dateSelect.appendChild(opt);
                    });
                } else {
                    dateSelect.innerHTML = '<option value="" disabled selected>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>';
                }
                dateSelect.disabled = false;
            } catch (err) {
                dateSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>';
                console.error("Load dates error:", err);
            }
        }
    </script>
</body>
</html>
